<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle de Incidencia</title>
    <link rel="stylesheet" href="../css/styles.css?v=">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <style>
        .archivo-container {
            position: relative;
            margin: 10px;
            display: inline-block;
            width: 150px;
            text-align: center;
            border: 1px solid #ddd;
            padding: 5px;
            border-radius: 5px;
            background: #f9f9f9;
            transition: all 0.3s ease;
        }
        .archivo-container:hover {
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .eliminar-archivo {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: #4c3535;
            color: white;
            border: none;
            border-radius: 15%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.8;
            transition: all 0.3s ease;
        }
        .eliminar-archivo:hover {
            background-color: #cd1a1a;
            opacity: 1;
            transform: scale(1.1);
        }
        .video-thumbnail {
            width: 100%;
            height: 100px;
            object-fit: cover;
            background: #000;
        }
        .image-thumbnail {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 3px;
        }
        .file-icon {
            font-size: 50px;
            color: #666;
            margin: 20px 0;
        }
        .file-name {
            word-break: break-word;
            font-size: 12px;
            margin-top: 5px;
            color: #555;
        }
        .file-type {
            font-size: 10px;
            color: #888;
            margin-top: 3px;
        }
    </style>
</head>
<body>

    <div class="retorna">
        <a href="incidencias.html"><<- Volver a Incidencias</a>
    </div>

    <!-- Panel lateral -->
    <aside class="sidebar">
        <ul>
            <li><a href="/index.html">Inicio</a></li>
            <li><a href="incidencias.html">Incidencias</a></li>
            <li><a href="reportes.html">Buscar incidencias</a></li>
            <li><a href="clientes.html">Clientes</a></li>
            <li><a href="usuarios.html">Usuarios</a></li>
            <li><a href="#">Configuración</a></li>
        </ul>
    </aside>

    <!-- Contenido principal -->
    <main>
        <!-- Formulario para ACTUALIZAR una incidencia -->
        <section class="encabezado">
            <h2>Detalles de la Incidencia</h2>
            <div id="detalle-incidencia">
                <p>Cargando detalles...</p>
            </div>
        </section>
        
        <section class="archivos-incidencia">
            <h2>Archivos de la Incidencia</h2>
            <div id="contenedor-archivos" style="display: flex; flex-wrap: wrap;"></div>
        </section>
    </main>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const params = new URLSearchParams(window.location.search);
            const id = params.get("id");

            if (!id) {
                document.getElementById("detalle-incidencia").innerHTML = "<p>Error: ID no encontrado.</p>";
                return;
            }

            // Función para renderizar miniaturas de PDF
            function renderPDFThumbnail(url, containerId) {
                const loadingTask = pdfjsLib.getDocument(url);
                loadingTask.promise.then(pdf => {
                    return pdf.getPage(1);
                }).then(page => {
                    const scale = 1.0;
                    const viewport = page.getViewport({ scale });

                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;

                    const renderContext = {
                        canvasContext: context,
                        viewport: viewport
                    };

                    return page.render(renderContext).promise.then(() => {
                        const container = document.getElementById(containerId);
                        if (container) {
                            container.innerHTML = '';
                            canvas.style.width = '100%';
                            canvas.style.height = '100px';
                            canvas.style.objectFit = 'contain';
                            container.appendChild(canvas);
                            
                            // Agregar nombre del archivo
                            const fileName = document.createElement('div');
                            fileName.className = 'file-name';
                            fileName.textContent = url.split('/').pop().substring(0, 20) + (url.split('/').pop().length > 20 ? '...' : '');
                            container.appendChild(fileName);
                            
                            // Agregar tipo de archivo
                            const fileType = document.createElement('div');
                            fileType.className = 'file-type';
                            fileType.textContent = 'PDF';
                            container.appendChild(fileType);
                        }
                    });
                }).catch(error => {
                    console.error('Error al renderizar miniatura PDF:', error);
                    const container = document.getElementById(containerId);
                    if (container) {
                        container.innerHTML = `
                            <div class="file-icon">📄</div>
                            <div class="file-name">${url.split('/').pop().substring(0, 20) + (url.split('/').pop().length > 20 ? '...' : '')}</div>
                            <div class="file-type">PDF</div>
                        `;
                    }
                });
            }

            // Función para crear miniatura de video
            function createVideoThumbnail(url, containerId) {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                const video = document.createElement('video');
                video.src = url;
                video.preload = 'metadata';
                video.style.width = '100%';
                video.style.height = '100px';
                video.style.objectFit = 'cover';
                
                video.onloadedmetadata = function() {
                    // Capturar frame en el segundo 1
                    video.currentTime = 1;
                };
                
                video.onseeked = function() {
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    container.innerHTML = '';
                    const thumbnail = new Image();
                    thumbnail.src = canvas.toDataURL();
                    thumbnail.className = 'video-thumbnail';
                    container.appendChild(thumbnail);
                    
                    // Agregar nombre del archivo
                    const fileName = document.createElement('div');
                    fileName.className = 'file-name';
                    fileName.textContent = url.split('/').pop().substring(0, 20) + (url.split('/').pop().length > 20 ? '...' : '');
                    container.appendChild(fileName);
                    
                    // Agregar tipo de archivo
                    const fileType = document.createElement('div');
                    fileType.className = 'file-type';
                    fileType.textContent = 'Video';
                    container.appendChild(fileType);
                    
                    // Agregar icono de play
                    const playIcon = document.createElement('div');
                    playIcon.innerHTML = '▶';
                    playIcon.style.position = 'absolute';
                    playIcon.style.top = '50%';
                    playIcon.style.left = '50%';
                    playIcon.style.transform = 'translate(-50%, -50%)';
                    playIcon.style.color = 'white';
                    playIcon.style.fontSize = '24px';
                    playIcon.style.textShadow = '0 0 5px rgba(0,0,0,0.5)';
                    container.appendChild(playIcon);
                };
                
                video.onerror = function() {
                    container.innerHTML = `
                        <div class="file-icon">🎬</div>
                        <div class="file-name">${url.split('/').pop().substring(0, 20) + (url.split('/').pop().length > 20 ? '...' : '')}</div>
                        <div class="file-type">Video</div>
                    `;
                };
            }

            // Función para eliminar un archivo
            function eliminarArchivo(urlArchivo) {
                if (!confirm('¿Estás seguro de que deseas eliminar este archivo?')) {
                    return;
                }

                fetch("../backend/eliminar_archivo.php", {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id_incidencia: id,
                        url_archivo: urlArchivo
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("Archivo eliminado correctamente");
                        // Recargar los archivos
                        cargarArchivosAdjuntos(data.archivos);
                    } else {
                        alert(data.error || "Error al eliminar el archivo");
                    }
                })
                .catch(error => {
                    console.error("Error al eliminar archivo:", error);
                    alert("Ocurrió un error al eliminar el archivo");
                });
            }

            // Función para cargar y mostrar archivos adjuntos
            function cargarArchivosAdjuntos(archivos) {
                const contenedorArchivos = document.getElementById("contenedor-archivos");
                contenedorArchivos.innerHTML = "";

                if (archivos && archivos.length > 0) {
                    archivos.forEach((archivo, index) => {
                        const ext = archivo.split('.').pop().toLowerCase();
                        const archivoContainer = document.createElement('div');
                        archivoContainer.className = 'archivo-container';
                        const containerId = `file-container-${index}`;
                        archivoContainer.id = containerId;
                        
                        // Agregar botón de eliminar
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'eliminar-archivo';
                        deleteBtn.innerHTML = '×';
                        deleteBtn.onclick = function(e) { 
                            e.stopPropagation();
                            eliminarArchivo(archivo); 
                        };
                        archivoContainer.appendChild(deleteBtn);

                        // Crear enlace para abrir el archivo
                        const link = document.createElement('a');
                        link.href = archivo;
                        link.target = '_blank';
                        link.style.textDecoration = 'none';
                        link.style.color = 'inherit';

                        if (["jpg", "jpeg", "png", "gif"].includes(ext)) {
                            // Miniaturas para imágenes
                            const img = document.createElement('img');
                            img.src = archivo;
                            img.className = 'image-thumbnail';
                            img.onerror = function() {
                                link.innerHTML = `
                                    <div class="file-icon">🖼️</div>
                                    <div class="file-name">${archivo.split('/').pop().substring(0, 20) + (archivo.split('/').pop().length > 20 ? '...' : '')}</div>
                                    <div class="file-type">Imagen</div>
                                `;
                            };
                            link.appendChild(img);
                            
                            // Agregar nombre del archivo
                            const fileName = document.createElement('div');
                            fileName.className = 'file-name';
                            fileName.textContent = archivo.split('/').pop().substring(0, 20) + (archivo.split('/').pop().length > 20 ? '...' : '');
                            link.appendChild(fileName);
                            
                            // Agregar tipo de archivo
                            const fileType = document.createElement('div');
                            fileType.className = 'file-type';
                            fileType.textContent = 'Imagen';
                            link.appendChild(fileType);
                            
                        } else if (ext === "pdf") {
                            // Miniaturas para PDF
                            link.innerHTML = `
                                <div class="file-icon">📄</div>
                                <div class="file-name">${archivo.split('/').pop().substring(0, 20) + (archivo.split('/').pop().length > 20 ? '...' : '')}</div>
                                <div class="file-type">PDF</div>
                            `;
                            setTimeout(() => renderPDFThumbnail(archivo, containerId), 100);
                            
                        } else if (["mp4", "webm", "ogg"].includes(ext)) {
                            // Miniaturas para video
                            link.innerHTML = `
                                <div class="file-icon">🎬</div>
                                <div class="file-name">${archivo.split('/').pop().substring(0, 20) + (archivo.split('/').pop().length > 20 ? '...' : '')}</div>
                                <div class="file-type">Video</div>
                            `;
                            setTimeout(() => createVideoThumbnail(archivo, containerId), 100);
                            
                        } else {
                            // Icono genérico para otros tipos de archivo
                            link.innerHTML = `
                                <div class="file-icon">📁</div>
                                <div class="file-name">${archivo.split('/').pop().substring(0, 20) + (archivo.split('/').pop().length > 20 ? '...' : '')}</div>
                                <div class="file-type">${ext.toUpperCase()}</div>
                            `;
                        }

                        archivoContainer.appendChild(link);
                        contenedorArchivos.appendChild(archivoContainer);
                    });
                } else {
                    contenedorArchivos.innerHTML = "<p>No hay archivos adjuntos.</p>";
                }
            }

            // [Resto del código permanece igual...]
            
            // Cargar datos de la incidencia
            fetch(`../backend/detalle.php?id=${id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById("detalle-incidencia").innerHTML = `<p>${data.error}</p>`;
                        return;
                    }

                    // Mostrar formulario de edición
                    document.getElementById("detalle-incidencia").innerHTML = `
                        <form id="form-editar">
                            <p><strong># REPORTE INTERNO:</strong> ${data.numero_incidente}</p>
                            <div>
                                <div>
                                    <label># INCIDENCIA CLIENTE:</label> 
                                    <input type="text" id="numero" value="${data.numero}">
                                </div>    
                                
                                <div>
                                    <label>CLIENTE:</label> 
                                    <input type="text" id="cliente" value="${data.cliente}" required>
                                </div>  
                            </div>
                            
                            <p><strong>CONTACTO:</strong> 
                                <input type="text" id="contacto" value="${data.contacto}" required>
                            </p>
                            <p><strong>SUCURSAL:</strong> 
                                <input type="text" id="sucursal" value="${data.sucursal}" required>
                            </p>
                            <p><strong>FECHA:</strong> 
                                <input type="date" id="fecha" value="${data.fecha}" required>
                            </p>
                            <p><strong>TÉCNICO:</strong> 
                                <input type="text" id="tecnico" value="${data.tecnico}" required>
                            </p>
                            <p><strong>ESTATUS:</strong> 
                                <select id="estatus">
                                    <option value="Abierta" ${data.estatus === "Abierta" ? 'selected' : ''}>Abierta</option>
                                    <option value="Pendiente" ${data.estatus === "Pendiente" ? 'selected' : ''}>Pendiente</option>
                                    <option value="En seguimiento" ${data.estatus === "En seguimiento" ? 'selected' : ''}>En seguimiento</option>
                                    <option value="Cerrada" ${data.estatus === "Cerrada" ? 'selected' : ''}>Cerrada</option>
                                    <option value="Facturada" ${data.estatus === "Facturada" ? 'selected' : ''}>Facturada</option>
                                </select>
                            </p>
                            <p><strong>FALLA:</strong><br>
                                <textarea id="falla" required rows="4" cols="50">${data.falla}</textarea>
                            </p>
                            <p><strong>TRABAJO REALIZADO:</strong><br>
                                <textarea id="accion" rows="4" cols="50">${data.accion}</textarea>
                            </p>
                            <p><strong>AGREGAR NUEVOS ARCHIVOS:</strong><br>
                                <input type="file" id="archivos" name="archivos[]" multiple accept=".pdf,.jpg,.jpeg,.png,.mp4,.webm,.ogg">
                            </p>
                            <button type="submit">Guardar cambios</button>
                        </form>
                    `;

                    // Cargar archivos adjuntos
                    if (data.archivos) {
                        cargarArchivosAdjuntos(data.archivos);
                    }

                    // [Resto del código del formulario permanece igual...]
                })
                .catch(error => {
                    console.error("Error al cargar detalles:", error);
                    document.getElementById("detalle-incidencia").innerHTML = 
                        "<p>Error al cargar los detalles de la incidencia. Por favor, intente nuevamente.</p>";
                });
        });
    </script>
</body>
</html>